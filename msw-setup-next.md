# MSW Next.js Integration Reference

> Extracted from https://github.com/mswjs/examples/pull/101/files

## Overview

This document contains the complete MSW (Mock Service Worker) integration setup for Next.js applications, based on the official MSW examples repository. This implementation supports both server-side and client-side mocking in Next.js App Router.

## Core Files Structure

```
mocks/
├── handlers.ts      # Mock handlers for HTTP and GraphQL
├── browser.ts       # Browser-side worker setup
└── node.ts          # Node.js server setup

app/
├── layout.tsx       # Root layout with MSW server setup
├── msw-provider.tsx # Client-side MSW provider component
└── ...              # Other app files
```

## Implementation Details

### 1. Mock Handlers (`mocks/handlers.ts`)

```typescript
import { http, graphql, HttpResponse } from 'msw'

export const handlers = [
  // HTTP API mocking
  http.get('https://api.example.com/user', () => {
    return HttpResponse.json({
      firstName: 'Sarah',
      lastName: 'Maverick',
    })
  }),
  
  // GraphQL API mocking
  graphql.query('ListMovies', () => {
    return HttpResponse.json({
      data: {
        movies: [
          { id: '6c6dba95-e027-4fe2-acab-e8c155a7f0ff', title: 'Lord of The Rings' },
          { id: 'a2ae7712-75a7-47bb-82a9-8ed668e00fe3', title: 'The Matrix' },
          { id: '916fa462-3903-4656-9e76-3f182b37c56f', title: 'Star Wars: The Empire Strikes Back' },
        ],
      },
    })
  }),
]
```

### 2. Browser Setup (`mocks/browser.ts`)

```typescript
import { setupWorker } from 'msw/browser'

export const worker = setupWorker()
```

### 3. Node.js Setup (`mocks/node.ts`)

```typescript
import { setupServer } from 'msw/node'
import { handlers } from './handlers'

export const server = setupServer(...handlers)
```

### 4. MSW Provider (`app/msw-provider.tsx`)

```typescript
'use client'

import { Suspense, use } from 'react'
import { handlers } from '@/mocks/handlers'

const mockingEnabledPromise =
  typeof window !== 'undefined'
    ? import('@/mocks/browser').then(async ({ worker }) => {
        await worker.start({
          onUnhandledRequest(request, print) {
            if (request.url.includes('_next')) {
              return
            }
            print.warning()
          },
        })
        worker.use(...handlers)
      })
    : Promise.resolve()

export function MSWProvider({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <Suspense fallback={null}>
      <MSWProviderWrapper>{children}</MSWProviderWrapper>
    </Suspense>
  )
}

function MSWProviderWrapper({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  use(mockingEnabledPromise)
  return children
}
```

### 5. Root Layout (`app/layout.tsx`)

```typescript
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import { MSWProvider } from './msw-provider'

// Server-side MSW setup
if (process.env.NEXT_RUNTIME === 'nodejs') {
  const { server } = require('@/mocks/node')
  server.listen()
}

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <MSWProvider>{children}</MSWProvider>
      </body>
    </html>
  )
}
```

## Key Features

### Server-Side Mocking
- Automatic MSW server setup in Node.js runtime
- Intercepts API calls during SSR
- Handles server-side rendering with mocked data

### Client-Side Mocking
- Service Worker setup for browser environment
- Filters out Next.js internal requests (`_next`)
- Suspense-based initialization
- Uses React `use()` hook for promise handling

### Hybrid Approach
- Unified handler definitions for both server and client
- Consistent mocking across SSR and CSR
- Environment-specific worker initialization

## Dependencies

Based on the implementation, required dependencies include:

```json
{
  "dependencies": {
    "msw": "^2.x.x"
  },
  "devDependencies": {
    "@types/react": "^18.x.x",
    "@types/node": "^20.x.x"
  }
}
```

## Testing Integration

The implementation includes Playwright E2E tests that verify:
- Server-side mocked responses
- Client-side mocked GraphQL responses
- Proper isolation between test environments

## Next.js App Router Compatibility

- Compatible with Next.js 13+ App Router
- Uses React Server Components patterns
- Handles both server and client environments
- Respects React 18+ features (Suspense, use hook)

## Special Considerations

1. **Environment Detection**: Uses `typeof window !== 'undefined'` to detect browser environment
2. **Next.js Request Filtering**: Excludes `_next` requests from mocking to avoid interference
3. **Conditional Imports**: Dynamic imports prevent server-side execution of browser-only code
4. **Suspense Boundaries**: Proper handling of async MSW initialization

## Usage Patterns

### HTTP API Mocking
```typescript
http.get('/api/users', () => {
  return HttpResponse.json({ users: [] })
})
```

### GraphQL Mocking
```typescript
graphql.query('GetUser', () => {
  return HttpResponse.json({
    data: { user: { id: 1, name: 'John' } }
  })
})
```

### Error Responses
```typescript
http.get('/api/error', () => {
  return HttpResponse.json(
    { error: 'Internal Server Error' },
    { status: 500 }
  )
})
```

This reference provides a complete foundation for integrating MSW with Next.js applications using the App Router architecture.